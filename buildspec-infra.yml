version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17
    commands:
      - echo "ğŸ”§ [APP] DÃ©but de l'installation"
      - mvn --version

      - echo "Connexion Ã  ECR"
      - aws ecr get-login-password --region eu-west-3 | docker login --username AWS --password-stdin 116981792309.dkr.ecr.eu-west-3.amazonaws.com

      - echo "ğŸ“¦ [INFRA] Installation de Terraform..."
      - curl -s -o terraform.zip https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
      - unzip -o terraform.zip
      - mv terraform /usr/local/bin/
      - terraform version

  pre_build:
    commands:
      - echo "ğŸ”¨ [APP] VÃ©rifie si le repo ECR existe..."
      - |
        aws ecr describe-repositories --repository-names petclinic --region eu-west-3 || \
        aws ecr create-repository --repository-name petclinic --region eu-west-3

      - echo "ğŸ” [INFRA] Connexion Ã  AWS"
      - aws sts get-caller-identity

  build:
    commands:
      - echo "ğŸ”¨ [APP] Compilation et Dockerisation intelligente des microservices"
      - chmod +x push-ecr.sh
      - ./push-ecr.sh

      - echo "âš™ï¸ [INFRA] Initialisation de Terraform..."
      - cd terraform-config
      - terraform init

      - echo "ğŸ”„ [INFRA] Synchronisation avec l'Ã©tat distant"
      - terraform refresh

      - echo "ğŸ“¦ [INFRA] Planification de l'infrastructure..."
      - terraform plan -out=tfplan

      - echo "ğŸš€ [INFRA] DÃ©ploiement de l'infrastructure..."
      - terraform apply -auto-approve tfplan

  post_build:
    commands:
      - echo "âœ… [INFRA] DÃ©ploiement terminÃ©"
      - echo "ğŸ“¤ [INFRA] Outputs de l'infrastructure"
      - cd terraform-config
      - terraform output

artifacts:
  files:
    - '**/*'

